<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Маршруты по Калининградской области</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }
        #poiPanel {
            position: fixed;
            top: 60px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            width: 300px;
            display: none;
        }
        .poi-item {
            margin-bottom: 10px;
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .poi-item:hover {
            background-color: #f8f9fa;
        }
        .close-poi {
            float: right;
            cursor: pointer;
            font-weight: bold;
        }
        .filter-controls {
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            background: white;
            padding-top: 10px;
            z-index: 1;
        }
        .start-point {
            color: #28a745;
            font-weight: bold;
        }
        .end-point {
            color: #dc3545;
            font-weight: bold;
        }
        #saveRouteBtn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            padding: 10px 20px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: none;
        }
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .map-container {
            height: 100%;
            padding-top: 56px;
        }
        .auth-links {
            display: flex;
            gap: 10px;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .alert {
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
        }
        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        #routesPanel {
            position: fixed;
            top: 60px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            width: 300px;
            display: none;
        }


        .route-item {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .route-item:hover {
            background-color: #f8f9fa;
        }

        .route-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }

        .route-item h5 {
            margin-bottom: 5px;
            color: #007bff;
        }

        .route-item small {
            color: #6c757d;
        }
        .leaflet-control-attribution {
            display: none !important;
           }
          #map-container {
            position: fixed; bottom: 1rem; right: 1rem; z-index: 1000;
            transition: all 0.3s ease; border: 2px solid #ccc;
            border-radius: 0.5rem; overflow: hidden; background: #fff;
        }
        #map-container.map-collapsed {
    /* Увеличенный размер для маленькой формы */
    width: 500px;
    height: 625px;
}
        #map-container.map-fullscreen {
    /* Полноэкранное состояние без скрытия навбара */
    top: 56px; /* высота navbar */
    left: 0;
    right: 0;
    bottom: 0;
    width: 100vw;
    height: calc(100vh - 56px);
    border-radius: 0;
    z-index: 900; /* ниже navbar (1000) */
}
        #map { width: 100%; height: calc(100% - 2.5rem); }
        #map-toggle-btn {
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 0.5rem;
            border-top: 1px solid #ccc; border-radius: 0 0 0.5rem 0.5rem;
            background: #007bff; color: #fff; cursor: pointer; text-align: center;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Маршруты по Калининграду</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Главная</a>
                    </li>
                    {% if user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadUserRoutes()">Мои маршруты</a>
                    </li>
                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    {% if user.is_authenticated %}
                        {% if user.is_staff %}
                        <li class="nav-item">
    <a class="nav-link btn btn-outline-success mx-2"
       href="{% url 'users:community' %}"
       style="border-radius: 20px;">
        <i class="bi bi-people-fill"></i> Сообщество
    </a>
</li>
                        {% endif %}
                        <li class="nav-item">
                            <a href="{% url 'users:profile' %}" class="nav-link">Профиль</a>
                        </li>
                        <li class="nav-item">
                            <form action="{% url 'users:logout' %}" method="post" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="nav-link btn btn-link" style="padding: 0.5rem 1rem;">Выйти</button>
                            </form>
                        </li>
                    {% else %}
                        <div class="auth-links">
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">Войти</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#registerModal">Регистрация</a>
                            </li>
                        </div>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    <div class="container mt-4">
        {% block content %}{% endblock %}  <!-- Добавьте этот блок -->
    </div>


 <div id="map-container" class="map-collapsed">
        <!-- Панель сохранённых маршрутов -->
        <div id="routesPanel">
            <span class="close-poi" onclick="document.getElementById('routesPanel').style.display='none'">×</span>
            <h4>Мои сохраненные маршруты</h4>
            <div id="routesList"></div>
        </div>
         <!-- Панель POI -->
        <div id="poiPanel">
    <span class="close-poi" onclick="document.getElementById('poiPanel').style.display='none'">×</span>
    <h4>Места поблизости</h4>
    <div class="filter-controls">
        <h5>Выбор способа передвижения:</h5>
        <select id="transportMode" class="form-select mb-3">
            <option value="driving" selected>Автомобиль</option>
            <option value="walking">Пешком</option>
            <option value="cycling">Велосипед</option>
            <option value="public_transport">Общественный транспорт</option>
        </select>

        <h5>Категории мест:</h5>
        <div class="category-icons">
            <div class="icon-wrapper">
                <input class="d-none filter-checkbox" type="checkbox" data-category="historic" id="historicCheck" checked>
                <label for="historicCheck" class="category-icon" title="Исторические">
                    <i class="fas fa-archway"></i>
                </label>
            </div>
            <div class="icon-wrapper">
                <input class="d-none filter-checkbox" type="checkbox" data-category="tourism" id="tourismCheck" checked>
                <label for="tourismCheck" class="category-icon" title="Достопримечательности">
                    <i class="fas fa-camera-retro"></i>
                </label>
            </div>
            <div class="icon-wrapper">
                <input class="d-none filter-checkbox" type="checkbox" data-category="museum" id="museumCheck" checked>
                <label for="museumCheck" class="category-icon" title="Музеи">
                    <i class="fas fa-landmark"></i>
                </label>
            </div>
            <div class="icon-wrapper">
                <input class="d-none filter-checkbox" type="checkbox" data-category="religion" id="religionCheck" checked>
                <label for="religionCheck" class="category-icon" title="Религия">
                    <i class="fas fa-place-of-worship"></i>
                </label>
            </div>
            <div class="icon-wrapper">
                <input class="d-none filter-checkbox" type="checkbox" data-category="hotel" id="hotelCheck" checked>
                <label for="hotelCheck" class="category-icon" title="Отели/Хостелы">
                    <i class="fas fa-hotel"></i>
                </label>
            </div>
            <div class="icon-wrapper">
                <input class="d-none filter-checkbox" type="checkbox" data-category="restaurant" id="restaurantCheck" checked>
                <label for="restaurantCheck" class="category-icon" title="Кафе/Рестораны">
                    <i class="fas fa-utensils"></i>
                </label>
            </div>
        </div>
    </div>
    <div id="poiList"></div>
</div>

<style>
#poiPanel {
    width: 340px;
    padding: 15px;
    box-sizing: border-box;
}

.save-route-btn {
    width: 100%;
    padding: 10px;
    margin: 10px 0 15px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.2s;
}

.save-route-btn:hover {
    background: #0056b3;
}

.category-icons {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
    width: 100%;
}

.icon-wrapper {
    display: flex;
    justify-content: center;
}

.category-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    border-radius: 8px;
    background: #f0f0f0;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.category-icon:hover {
    background: #e0e0e0;
}

.category-icon i {
    font-size: 1.3rem;
    color: #666;
}

.filter-checkbox:checked + .category-icon {
    background: #007bff;
    border-color: #0056b3;
}

.filter-checkbox:checked + .category-icon i {
    color: white;
}
</style>



        <!-- НЕ перемещайте КНОПКУ "Сохранить" внутрь контейнера -->

        <!-- Карта -->
        <div id="map"></div>
        <!-- Кнопка-разворачивалка: вставьте НИЖЕ КАРТЫ -->
        <button id="map-toggle-btn" class="btn btn-sm">Развернуть карту</button>
    </div>
     <button id="saveRouteBtn" class="btn btn-primary" {% if not user.is_authenticated %}onclick="showAuthAlert()"{% endif %}>Сохранить маршрут</button>
    <!-- Модальные окна для авторизации -->
    <!-- Вход -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Вход</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'users:login' %}">
                    <div class="modal-body">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="id_username">Email</label>
                            <input type="email" name="username" class="form-control" id="id_username" required>
                        </div>
                        <div class="form-group">
                            <label for="id_password">Пароль</label>
                            <input type="password" name="password" class="form-control" id="id_password" required>
                        </div>
                        {% if login_error %}
                        <div class="alert alert-danger">{{ login_error }}</div>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                        <button type="submit" class="btn btn-primary">Войти</button>
                    </div>
                </form>
                <div class="modal-footer justify-content-center">
                    <p>Нет аккаунта? <a href="#" data-bs-toggle="modal" data-bs-target="#registerModal" data-bs-dismiss="modal">Зарегистрируйтесь</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Регистрация -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerModalLabel">Регистрация</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'users:register' %}">
                    <div class="modal-body">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="id_email">Email</label>
                            <input type="email" name="email" class="form-control" id="id_email" required>
                        </div>
                        <div class="form-group">
                            <label for="id_password1">Пароль</label>
                            <input type="password" name="password1" class="form-control" id="id_password1" required>
                        </div>
                        <div class="form-group">
                            <label for="id_password2">Подтвердите пароль</label>
                            <input type="password" name="password2" class="form-control" id="id_password2" required>
                        </div>
                        {% if register_errors %}
                        <div class="alert alert-danger">
                            {% for error in register_errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                        <button type="submit" class="btn btn-primary">Зарегистрироваться</button>
                    </div>
                </form>
                <div class="modal-footer justify-content-center">
                    <p>Уже есть аккаунт? <a href="#" data-bs-toggle="modal" data-bs-target="#loginModal" data-bs-dismiss="modal">Войдите</a></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script>
         window.map = L.map('map').setView([54.7104, 20.4522], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(window.map);

         document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('map-container');
            const btn = document.getElementById('map-toggle-btn');
            btn.addEventListener('click', function() {
                const expanded = container.classList.toggle('map-fullscreen');
                container.classList.toggle('map-collapsed', !expanded);
                btn.textContent = expanded ? 'Свернуть карту' : 'Развернуть карту';
                setTimeout(() => window.map.invalidateSize(), 300);
            });
        });

        let markers = [];
        let routeLine = null;
        let poiMarkers = [];
        let allPois = [];

        const poiCategories = {
            'historic': {name: 'Исторические места', icon: '🏛️', color: '#6f42c1'},
            'tourism': {name: 'Достопримечательности', icon: '📷', color: '#20c997'},
            'museum': {name: 'Музеи', icon: '🖼️', color: '#fd7e14'},
            'religion': {name: 'Религиозные места', icon: '⛪', color: '#17a2b8'},
            'hotel': {name: 'Отели/Хостелы', icon: '🏨', color: '#007bff'},
            'restaurant': {name: 'Кафе/Рестораны', icon: '🍴', color: '#dc3545'}
        };
        const groupMapping = {
            'Проживание': ['hotel'],
            'Еда / Рестораны': ['restaurant'],
            'Достопримечательности': ['tourism','museum','historic'],
            'Мероприятия': [] // Пока пусто, можно добавить по необходимости
        };
        // Обработчики для категорий
        document.querySelectorAll('#poiPanel details').forEach(detail => {
            detail.addEventListener('toggle', updatePoiList);
        });
        // Обработчик для выбора транспорта
        const transportSelect = document.getElementById('transportMode');
        if (transportSelect) transportSelect.addEventListener('change', () => {
            if (markers.length === 2) updateRoute();
        });

        // Расширяем updatePoiList с учётом групп
        function updatePoiList() {
            const openDetails = Array.from(document.querySelectorAll('#poiPanel details[open]'))
                .map(d => d.dataset.category);
            // Собираем все poi.category, соответствующие выбранным группам
            let activeCategories = [];
            openDetails.forEach(group => {
                if (groupMapping[group]) activeCategories = activeCategories.concat(groupMapping[group]);
            });
            // Фильтрация POI
            const filteredPois = allPois.filter(poi => activeCategories.includes(poi.category));
            const poiList = document.getElementById('poiList');
            poiList.innerHTML = '';
            clearPoiMarkers();
            if (filteredPois.length === 0) {
                poiList.innerHTML = '<div class="alert alert-info">Нет мест по выбранным категориям</div>';
                return;
            }
            // Группируем по poi.category для отображения
            const grouped = {};
            filteredPois.forEach(poi => {
                if (!grouped[poi.category]) grouped[poi.category] = [];
                grouped[poi.category].push(poi);
            });
            Object.entries(grouped).forEach(([cat, pois]) => {
                const header = document.createElement('h5');
                header.textContent = poiCategories[cat].icon + ' ' + poiCategories[cat].name;
                poiList.appendChild(header);
                pois.forEach(poi => {
                    const item = document.createElement('div');
                    item.className = 'poi-item';
                    item.innerHTML = `<h6>${poi.name}</h6><small>${poi.tags.description||''}</small>`;
                    item.onclick = () => highlightPoi(poi);
                    poiList.appendChild(item);
                });
            });
            // Отображаем маркеры
            filteredPois.forEach(poi => {
                const marker = L.marker([poi.lat, poi.lon], {
                    icon: L.divIcon({
                        className: 'poi-marker',
                        html: `<span style="background-color: ${poiCategories[poi.category].color}; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">${poiCategories[poi.category].icon}</span>`,
                        iconSize: [24,24]
                    })
                }).addTo(window.map).bindPopup(`<b>${poi.name}</b>`);
                poiMarkers.push(marker);
            });
        }


        function resetRoute() {
            if (routeLine) {
                map.removeLayer(routeLine);
                routeLine = null;
            }
        }

        function clearPoiMarkers() {
            poiMarkers.forEach(marker => map.removeLayer(marker));
            poiMarkers = [];
        }

        function getPoiCategory(tags) {
            if (!tags) return null;

            if (tags.historic) return 'historic';
            if (tags.tourism === 'museum') return 'museum';
            if (tags.tourism === 'attraction' || tags.tourism === 'viewpoint') return 'tourism';
            if (tags['amenity'] === 'place_of_worship') return 'religion';
            if (tags['tourism'] === 'hotel' || tags['tourism'] === 'hostel' || tags['amenity'] === 'hotel') return 'hotel';
            if (tags['amenity'] === 'restaurant' || tags['amenity'] === 'cafe' || tags['amenity'] === 'bar') return 'restaurant';
            return null;
        }

        async function fetchPOIs(lat, lng, radius = 1500) {
            try {
                const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];
                    (
                        node["historic"]["name"](around:${radius},${lat},${lng});
                        node["tourism"="museum"]["name"](around:${radius},${lat},${lng});
                        node["tourism"~"attraction|viewpoint"]["name"](around:${radius},${lat},${lng});
                        node["amenity"="place_of_worship"]["name"](around:${radius},${lat},${lng});
                        node["tourism"~"hotel|hostel"]["name"](around:${radius},${lat},${lng});
                        node["amenity"~"hotel"]["name"](around:${radius},${lat},${lng});
                        node["amenity"~"restaurant|cafe|bar"]["name"](around:${radius},${lat},${lng});
                        way["historic"]["name"](around:${radius},${lat},${lng});
                        way["tourism"="museum"]["name"](around:${radius},${lat},${lng});
                        way["tourism"~"attraction|viewpoint"]["name"](around:${radius},${lat},${lng});
                        way["amenity"="place_of_worship"]["name"](around:${radius},${lat},${lng});
                        way["tourism"~"hotel|hostel"]["name"](around:${radius},${lat},${lng});
                        way["amenity"~"restaurant|cafe|bar"]["name"](around:${radius},${lat},${lng});
                    );
                    out center;`;

                const response = await fetch(overpassUrl);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                const pois = [];
                data.elements.forEach(element => {
                    const coords = element.type === 'node' ?
                        { lat: element.lat, lon: element.lon } :
                        { lat: element.center.lat, lon: element.center.lon };

                    const category = getPoiCategory(element.tags);
                    if (!category || !element.tags?.name) return;

                    pois.push({
                        id: element.id,
                        name: element.tags.name,
                        lat: coords.lat,
                        lon: coords.lon,
                        tags: element.tags,
                        category: category,
                        distance: getDistance(lat, lng, coords.lat, coords.lon)
                    });
                });

                return pois;
            } catch (error) {
                console.error('Ошибка при загрузке POI:', error);
                return [];
            }
        }

        async function showNearbyPOIs() {
            if (markers.length === 0) return;

            clearPoiMarkers();
            const poiList = document.getElementById('poiList');
            poiList.innerHTML = '<div class="text-center"><span class="loading-spinner"></span> Загрузка мест...</div>';

            document.getElementById('poiPanel').style.display = 'block';

            try {
                const poiPromises = markers.map((marker, index) => {
                    const latlng = marker.getLatLng();
                    return fetchPOIs(latlng.lat, latlng.lng).then(pois => {
                        return pois.map(poi => ({
                            ...poi,
                            routePointIndex: index,
                            routePointType: index === 0 ? 'start' : 'end'
                        }));
                    });
                });

                const poisArrays = await Promise.all(poiPromises);
                allPois = [].concat(...poisArrays);

                // Удаляем дубликаты
                const uniquePois = [];
                const seenIds = new Set();

                allPois.forEach(poi => {
                    if (!seenIds.has(poi.id)) {
                        seenIds.add(poi.id);
                        uniquePois.push(poi);
                    }
                });

                allPois = uniquePois.sort((a, b) => a.distance - b.distance);

                if (allPois.length === 0) {
                    poiList.innerHTML = '<div class="alert alert-info">Не найдено мест поблизости. Попробуйте выбрать другие точки.</div>';
                } else {
                    updatePoiList();
                }
            } catch (error) {
                console.error('Ошибка:', error);
                poiList.innerHTML = '<div class="alert alert-danger">Ошибка при загрузке данных. Попробуйте позже.</div>';
            }
        }

        function updatePoiList() {
            const poiList = document.getElementById('poiList');
            poiList.innerHTML = '';

            const activeFilters = Array.from(document.querySelectorAll('.filter-checkbox:checked'))
                .map(el => el.dataset.category);

            const filteredPois = allPois.filter(poi => activeFilters.includes(poi.category));

            if (filteredPois.length === 0) {
                poiList.innerHTML = '<div class="alert alert-info">Нет мест по выбранным фильтрам</div>';
                return;
            }

            const groupedPois = {};
            filteredPois.forEach(poi => {
                if (!groupedPois[poi.category]) {
                    groupedPois[poi.category] = [];
                }
                groupedPois[poi.category].push(poi);
            });

            for (const [category, pois] of Object.entries(groupedPois)) {
                const categoryHeader = document.createElement('h5');
                categoryHeader.innerHTML = `${poiCategories[category].icon} ${poiCategories[category].name}`;
                categoryHeader.style.marginTop = '15px';
                categoryHeader.style.color = poiCategories[category].color;
                poiList.appendChild(categoryHeader);

                pois.forEach(poi => {
                    const pointTypeClass = poi.routePointType === 'start' ? 'start-point' : 'end-point';
                    const pointTypeText = poi.routePointType === 'start' ? 'Старт' : 'Финиш';

                    const item = document.createElement('div');
                    item.className = 'poi-item';
                    item.innerHTML = `
                        <h6>${poi.name}</h6>
                        <small class="text-muted">${poi.tags.description || poi.tags.historic || poi.tags.tourism || ''}</small>
                        <div><small>${poi.distance.toFixed(1)} км от <span class="${pointTypeClass}">${pointTypeText}</span></small></div>
                    `;
                    item.onclick = () => {
                        map.setView([poi.lat, poi.lon], 16);
                        highlightPoi(poi);
                    };
                    poiList.appendChild(item);
                });
            }

            updatePoiMarkers();
        }

        function updatePoiMarkers() {
            clearPoiMarkers();

            const activeFilters = Array.from(document.querySelectorAll('.filter-checkbox:checked'))
                .map(el => el.dataset.category);

            const filteredPois = allPois.filter(poi => activeFilters.includes(poi.category));

            filteredPois.forEach(poi => {
                const marker = L.marker([poi.lat, poi.lon], {
                    icon: L.divIcon({
                        className: 'poi-marker',
                        html: `<span style="background-color: ${poiCategories[poi.category].color}; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">${poiCategories[poi.category].icon}</span>`,
                        iconSize: [24, 24]
                    })
                }).addTo(map)
                    .bindPopup(`<b>${poi.name}</b><br>${poi.tags.description || ''}`);

                poiMarkers.push(marker);
            });
        }

        function highlightPoi(poi) {
            clearPoiMarkers();

            const marker = L.marker([poi.lat, poi.lon], {
                icon: L.divIcon({
                    className: 'poi-marker',
                    html: `<span style="background-color: ${poiCategories[poi.category].color}; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 16px;">${poiCategories[poi.category].icon}</span>`,
                    iconSize: [32, 32]
                })
            }).addTo(map)
                .bindPopup(`<b>${poi.name}</b><br>${poi.tags.description || ''}`)
                .openPopup();

            poiMarkers.push(marker);
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updateRoute() {
            resetRoute();
            if (markers.length === 2) {
                const [start, end] = markers.map(m => m.getLatLng());
                const url = `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.routes && data.routes.length > 0) {
                            const route = data.routes[0];
                            const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
                            routeLine = L.polyline(coords, {color: 'blue'}).addTo(map);

                            const distance = (route.distance / 1000).toFixed(2);
                            const duration = (route.duration / 60).toFixed(2);
                            const popupContent = `Расстояние: ${distance} км<br>Время: ${duration} мин`;

                            L.popup()
                                .setLatLng(end)
                                .setContent(popupContent)
                                .openOn(map);

                            document.getElementById('saveRouteBtn').style.display = 'inline';

                            showNearbyPOIs();
                        }
                    });
            }
        }

       async function loadUserRoutes() {
            if (!{{ user.is_authenticated|yesno:"true,false" }}) {
                alert('Для просмотра маршрутов необходимо войти в систему');
                return;
            }

            const routesPanel = document.getElementById('routesPanel');
            const routesList = document.getElementById('routesList');
            routesList.innerHTML = '<div class="text-center"><span class="loading-spinner"></span> Загрузка маршрутов...</div>';
            routesPanel.style.display = 'block';

            try {
                const response = await fetch('/api/user_routes/');
                const data = await response.json();

                if (data.error) {
                    routesList.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }

                if (data.routes.length === 0) {
                    routesList.innerHTML = '<div class="alert alert-info">У вас пока нет сохраненных маршрутов</div>';
                    return;
                }

                routesList.innerHTML = '';
                data.routes.forEach(route => {
                    const routeElement = document.createElement('div');
                    routeElement.className = 'route-item';
                    routeElement.innerHTML = `
                        <h5>${route.name}</h5>
                        <small>Старт: ${route.start_lat.toFixed(4)}, ${route.start_lng.toFixed(4)}</small><br>
                        <small>Финиш: ${route.end_lat.toFixed(4)}, ${route.end_lng.toFixed(4)}</small>
                        <div class="route-actions">
                            <button class="btn btn-sm btn-primary" onclick="buildRoute(${route.start_lat}, ${route.start_lng}, ${route.end_lat}, ${route.end_lng})">Построить</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRoute(${route.id})">Удалить</button>
                        </div>
                    `;
                    routesList.appendChild(routeElement);
                });
            } catch (error) {
                console.error('Ошибка:', error);
                routesList.innerHTML = '<div class="alert alert-danger">Ошибка загрузки маршрутов</div>';
            }
        }

       function buildRoute(startLat, startLng, endLat, endLng) {
            // Очистка предыдущих маркеров
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Добавление новых маркеров
            const startMarker = L.marker([startLat, startLng]).addTo(map);
            const endMarker = L.marker([endLat, endLng]).addTo(map);
            markers.push(startMarker, endMarker);

            // Построение маршрута
            updateRoute();
            document.getElementById('routesPanel').style.display = 'none';
        }

        async function deleteRoute(routeId) {
            if (!confirm('Вы уверены, что хотите удалить этот маршрут?')) return;

            try {
                const response = await fetch(`/api/delete_route/${routeId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                if (data.status === 'success') {
                    // Обновляем список без перезагрузки
                    loadUserRoutes();
                } else {
                    alert(data.error || 'Ошибка при удалении маршрута');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка соединения');
            }
        }


        function showAuthAlert() {
            alert('Для сохранения маршрута необходимо войти в систему');
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
        }

        // Обработчики событий
        document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updatePoiList);
        });

        map.on('click', function(e) {
            if (markers.length >= 2) {
                map.removeLayer(markers[0]);
                markers.shift();
                resetRoute();
                clearPoiMarkers();
                document.getElementById('poiPanel').style.display = 'none';
            }

            const marker = L.marker(e.latlng).addTo(map);
            markers.push(marker);

            marker.on('contextmenu', function() {
                map.removeLayer(marker);
                markers = markers.filter(m => m !== marker);
                resetRoute();
                clearPoiMarkers();
                document.getElementById('poiPanel').style.display = 'none';
            });

            if (markers.length === 2) {
                updateRoute();
            } else if (markers.length === 1) {
                showNearbyPOIs();
            }
        });

        document.getElementById('saveRouteBtn').addEventListener('click', saveRoute);

        // Автоматическое открытие модального окна при ошибках
        {% if login_error %}
        document.addEventListener('DOMContentLoaded', function() {
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
        });
        {% endif %}

        {% if register_errors %}
        document.addEventListener('DOMContentLoaded', function() {
            const registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
            registerModal.show();
        });
        {% endif %}
        async function saveRoute() {
    if (!{{ user.is_authenticated|yesno:"true,false" }}) {
        showAuthAlert();
        return;
    }

    if (markers.length !== 2) {
        alert('Для сохранения маршрута необходимо выбрать две точки');
        return;
    }

    const [start, end] = markers.map(m => m.getLatLng());
    const routeName = prompt('Введите название маршрута:') || 'Без названия';

    try {
        const response = await fetch('/api/save_route/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                start_lat: start.lat,
                start_lng: start.lng,
                end_lat: end.lat,
                end_lng: end.lng,
                name: routeName
            })
        });

        const data = await response.json();

        if (data.id) {
            alert(`Маршрут "${data.name}" успешно сохранен!`);
            loadUserRoutes();
        } else {
            alert('Ошибка сохранения: ' + (data.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка соединения с сервером');
    }
}
        document.getElementById('saveRouteBtn').addEventListener('click', saveRoute);
        function closeProfile() {
    const profileContainer = document.querySelector('.profile-full-container');
    profileContainer.classList.remove('active');

    // Возвращаем видимость карты
    document.querySelector('.map-container').style.display = 'block';

    // Очищаем историю, если нужно
    window.history.replaceState(null, null, window.location.pathname);
}
        document.addEventListener('DOMContentLoaded', function() {
    // Закрываем все модальные окна при загрузке
    $('.modal').modal('hide');

    // Обработчик для кнопки "Войти"
    document.querySelectorAll('[data-bs-target="#loginModal"]').forEach(btn => {
        btn.addEventListener('click', function() {
            $('#loginModal').modal('show');
        });
    });
});
        document.addEventListener('DOMContentLoaded', function() {
    var myModal = new bootstrap.Modal(document.getElementById('loginModal'));
    myModal.hide();

    // Очищаем параметры URL
    if(window.location.href.indexOf('?next=') > -1) {
        history.replaceState({}, document.title, "/");
    }
});
    </script>
</body>
</html>