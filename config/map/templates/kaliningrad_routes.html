<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Ä—à—Ä—É—Ç—ã –ø–æ –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }
        #poiPanel {
            position: fixed;
            top: 60px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            width: 300px;
            display: none;
        }
        .poi-item {
            margin-bottom: 10px;
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .poi-item:hover {
            background-color: #f8f9fa;
        }
        .close-poi {
            float: right;
            cursor: pointer;
            font-weight: bold;
        }
        .filter-controls {
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            background: white;
            padding-top: 10px;
            z-index: 1;
        }
        .start-point {
            color: #28a745;
            font-weight: bold;
        }
        .end-point {
            color: #dc3545;
            font-weight: bold;
        }
        #saveRouteBtn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            padding: 10px 20px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: none;
        }
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .map-container {
            height: 100%;
            padding-top: 56px;
        }
        .auth-links {
            display: flex;
            gap: 10px;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .alert {
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
        }
        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">–ú–∞—Ä—à—Ä—É—Ç—ã –ø–æ –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—É</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">–ì–ª–∞–≤–Ω–∞—è</a>
                    </li>
                    {% if user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'map:route_list' %}">–ú–æ–∏ –º–∞—Ä—à—Ä—É—Ç—ã</a>
                    </li>
                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    {% if user.is_authenticated %}
                        {% if user.is_staff %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'users:users' %}">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
                        </li>
                        {% endif %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'users:user_form' %}">–ü—Ä–æ—Ñ–∏–ª—å</a>
                        </li>
                        <li class="nav-item">
                            <form action="{% url 'users:logout' %}" method="post" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="nav-link btn btn-link" style="padding: 0.5rem 1rem;">–í—ã–π—Ç–∏</button>
                            </form>
                        </li>
                    {% else %}
                        <div class="auth-links">
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">–í–æ–π—Ç–∏</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#registerModal">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                            </li>
                        </div>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="map-container">
        <!-- –ü–∞–Ω–µ–ª—å POI -->
        <div id="poiPanel">
            <span class="close-poi" onclick="document.getElementById('poiPanel').style.display = 'none'">√ó</span>
            <h4>–ú–µ—Å—Ç–∞ –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏</h4>
            <div class="filter-controls">
                <h5>–§–∏–ª—å—Ç—Ä—ã:</h5>
                <div class="form-check">
                    <input class="form-check-input filter-checkbox" type="checkbox" data-category="historic" id="historicCheck" checked>
                    <label class="form-check-label" for="historicCheck">–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input filter-checkbox" type="checkbox" data-category="tourism" id="tourismCheck" checked>
                    <label class="form-check-label" for="tourismCheck">–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input filter-checkbox" type="checkbox" data-category="museum" id="museumCheck" checked>
                    <label class="form-check-label" for="museumCheck">–ú—É–∑–µ–∏</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input filter-checkbox" type="checkbox" data-category="religion" id="religionCheck" checked>
                    <label class="form-check-label" for="religionCheck">–†–µ–ª–∏–≥–∏—è</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input filter-checkbox" type="checkbox" data-category="hotel" id="hotelCheck" checked>
                    <label class="form-check-label" for="hotelCheck">–û—Ç–µ–ª–∏/–•–æ—Å—Ç–µ–ª—ã</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input filter-checkbox" type="checkbox" data-category="restaurant" id="restaurantCheck" checked>
                    <label class="form-check-label" for="restaurantCheck">–ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</label>
                </div>
            </div>
            <div id="poiList"></div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ -->
        <div id="map"></div>

        <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ -->
        <button id="saveRouteBtn" class="btn btn-primary" {% if not user.is_authenticated %}onclick="showAuthAlert()"{% endif %}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <!-- –í—Ö–æ–¥ -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">–í—Ö–æ–¥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'users:login' %}">
                    <div class="modal-body">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="id_username">Email</label>
                            <input type="email" name="username" class="form-control" id="id_username" required>
                        </div>
                        <div class="form-group">
                            <label for="id_password">–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" name="password" class="form-control" id="id_password" required>
                        </div>
                        {% if login_error %}
                        <div class="alert alert-danger">{{ login_error }}</div>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                        <button type="submit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
                    </div>
                </form>
                <div class="modal-footer justify-content-center">
                    <p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" data-bs-toggle="modal" data-bs-target="#registerModal" data-bs-dismiss="modal">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerModalLabel">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'users:register' %}">
                    <div class="modal-body">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="id_email">Email</label>
                            <input type="email" name="email" class="form-control" id="id_email" required>
                        </div>
                        <div class="form-group">
                            <label for="id_password1">–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" name="password1" class="form-control" id="id_password1" required>
                        </div>
                        <div class="form-group">
                            <label for="id_password2">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                            <input type="password" name="password2" class="form-control" id="id_password2" required>
                        </div>
                        {% if register_errors %}
                        <div class="alert alert-danger">
                            {% for error in register_errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                        <button type="submit" class="btn btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    </div>
                </form>
                <div class="modal-footer justify-content-center">
                    <p>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" data-bs-toggle="modal" data-bs-target="#loginModal" data-bs-dismiss="modal">–í–æ–π–¥–∏—Ç–µ</a></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        const map = L.map('map').setView([54.7104, 20.4522], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let markers = [];
        let routeLine = null;
        let poiMarkers = [];
        let allPois = [];

        const poiCategories = {
            'historic': {name: '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –º–µ—Å—Ç–∞', icon: 'üèõÔ∏è', color: '#6f42c1'},
            'tourism': {name: '–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏', icon: 'üì∑', color: '#20c997'},
            'museum': {name: '–ú—É–∑–µ–∏', icon: 'üñºÔ∏è', color: '#fd7e14'},
            'religion': {name: '–†–µ–ª–∏–≥–∏–æ–∑–Ω—ã–µ –º–µ—Å—Ç–∞', icon: '‚õ™', color: '#17a2b8'},
            'hotel': {name: '–û—Ç–µ–ª–∏/–•–æ—Å—Ç–µ–ª—ã', icon: 'üè®', color: '#007bff'},
            'restaurant': {name: '–ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω—ã', icon: 'üç¥', color: '#dc3545'}
        };

        function resetRoute() {
            if (routeLine) {
                map.removeLayer(routeLine);
                routeLine = null;
            }
        }

        function clearPoiMarkers() {
            poiMarkers.forEach(marker => map.removeLayer(marker));
            poiMarkers = [];
        }

        function getPoiCategory(tags) {
            if (!tags) return null;

            if (tags.historic) return 'historic';
            if (tags.tourism === 'museum') return 'museum';
            if (tags.tourism === 'attraction' || tags.tourism === 'viewpoint') return 'tourism';
            if (tags['amenity'] === 'place_of_worship') return 'religion';
            if (tags['tourism'] === 'hotel' || tags['tourism'] === 'hostel' || tags['amenity'] === 'hotel') return 'hotel';
            if (tags['amenity'] === 'restaurant' || tags['amenity'] === 'cafe' || tags['amenity'] === 'bar') return 'restaurant';
            return null;
        }

        async function fetchPOIs(lat, lng, radius = 1500) {
            try {
                const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];
                    (
                        node["historic"]["name"](around:${radius},${lat},${lng});
                        node["tourism"="museum"]["name"](around:${radius},${lat},${lng});
                        node["tourism"~"attraction|viewpoint"]["name"](around:${radius},${lat},${lng});
                        node["amenity"="place_of_worship"]["name"](around:${radius},${lat},${lng});
                        node["tourism"~"hotel|hostel"]["name"](around:${radius},${lat},${lng});
                        node["amenity"~"hotel"]["name"](around:${radius},${lat},${lng});
                        node["amenity"~"restaurant|cafe|bar"]["name"](around:${radius},${lat},${lng});
                        way["historic"]["name"](around:${radius},${lat},${lng});
                        way["tourism"="museum"]["name"](around:${radius},${lat},${lng});
                        way["tourism"~"attraction|viewpoint"]["name"](around:${radius},${lat},${lng});
                        way["amenity"="place_of_worship"]["name"](around:${radius},${lat},${lng});
                        way["tourism"~"hotel|hostel"]["name"](around:${radius},${lat},${lng});
                        way["amenity"~"restaurant|cafe|bar"]["name"](around:${radius},${lat},${lng});
                    );
                    out center;`;

                const response = await fetch(overpassUrl);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                const pois = [];
                data.elements.forEach(element => {
                    const coords = element.type === 'node' ?
                        { lat: element.lat, lon: element.lon } :
                        { lat: element.center.lat, lon: element.center.lon };

                    const category = getPoiCategory(element.tags);
                    if (!category || !element.tags?.name) return;

                    pois.push({
                        id: element.id,
                        name: element.tags.name,
                        lat: coords.lat,
                        lon: coords.lon,
                        tags: element.tags,
                        category: category,
                        distance: getDistance(lat, lng, coords.lat, coords.lon)
                    });
                });

                return pois;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ POI:', error);
                return [];
            }
        }

        async function showNearbyPOIs() {
            if (markers.length === 0) return;

            clearPoiMarkers();
            const poiList = document.getElementById('poiList');
            poiList.innerHTML = '<div class="text-center"><span class="loading-spinner"></span> –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Å—Ç...</div>';

            document.getElementById('poiPanel').style.display = 'block';

            try {
                const poiPromises = markers.map((marker, index) => {
                    const latlng = marker.getLatLng();
                    return fetchPOIs(latlng.lat, latlng.lng).then(pois => {
                        return pois.map(poi => ({
                            ...poi,
                            routePointIndex: index,
                            routePointType: index === 0 ? 'start' : 'end'
                        }));
                    });
                });

                const poisArrays = await Promise.all(poiPromises);
                allPois = [].concat(...poisArrays);

                // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
                const uniquePois = [];
                const seenIds = new Set();

                allPois.forEach(poi => {
                    if (!seenIds.has(poi.id)) {
                        seenIds.add(poi.id);
                        uniquePois.push(poi);
                    }
                });

                allPois = uniquePois.sort((a, b) => a.distance - b.distance);

                if (allPois.length === 0) {
                    poiList.innerHTML = '<div class="alert alert-info">–ù–µ –Ω–∞–π–¥–µ–Ω–æ –º–µ—Å—Ç –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–∏–µ —Ç–æ—á–∫–∏.</div>';
                } else {
                    updatePoiList();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                poiList.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div>';
            }
        }

        function updatePoiList() {
            const poiList = document.getElementById('poiList');
            poiList.innerHTML = '';

            const activeFilters = Array.from(document.querySelectorAll('.filter-checkbox:checked'))
                .map(el => el.dataset.category);

            const filteredPois = allPois.filter(poi => activeFilters.includes(poi.category));

            if (filteredPois.length === 0) {
                poiList.innerHTML = '<div class="alert alert-info">–ù–µ—Ç –º–µ—Å—Ç –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º</div>';
                return;
            }

            const groupedPois = {};
            filteredPois.forEach(poi => {
                if (!groupedPois[poi.category]) {
                    groupedPois[poi.category] = [];
                }
                groupedPois[poi.category].push(poi);
            });

            for (const [category, pois] of Object.entries(groupedPois)) {
                const categoryHeader = document.createElement('h5');
                categoryHeader.innerHTML = `${poiCategories[category].icon} ${poiCategories[category].name}`;
                categoryHeader.style.marginTop = '15px';
                categoryHeader.style.color = poiCategories[category].color;
                poiList.appendChild(categoryHeader);

                pois.forEach(poi => {
                    const pointTypeClass = poi.routePointType === 'start' ? 'start-point' : 'end-point';
                    const pointTypeText = poi.routePointType === 'start' ? '–°—Ç–∞—Ä—Ç' : '–§–∏–Ω–∏—à';

                    const item = document.createElement('div');
                    item.className = 'poi-item';
                    item.innerHTML = `
                        <h6>${poi.name}</h6>
                        <small class="text-muted">${poi.tags.description || poi.tags.historic || poi.tags.tourism || ''}</small>
                        <div><small>${poi.distance.toFixed(1)} –∫–º –æ—Ç <span class="${pointTypeClass}">${pointTypeText}</span></small></div>
                    `;
                    item.onclick = () => {
                        map.setView([poi.lat, poi.lon], 16);
                        highlightPoi(poi);
                    };
                    poiList.appendChild(item);
                });
            }

            updatePoiMarkers();
        }

        function updatePoiMarkers() {
            clearPoiMarkers();

            const activeFilters = Array.from(document.querySelectorAll('.filter-checkbox:checked'))
                .map(el => el.dataset.category);

            const filteredPois = allPois.filter(poi => activeFilters.includes(poi.category));

            filteredPois.forEach(poi => {
                const marker = L.marker([poi.lat, poi.lon], {
                    icon: L.divIcon({
                        className: 'poi-marker',
                        html: `<span style="background-color: ${poiCategories[poi.category].color}; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">${poiCategories[poi.category].icon}</span>`,
                        iconSize: [24, 24]
                    })
                }).addTo(map)
                    .bindPopup(`<b>${poi.name}</b><br>${poi.tags.description || ''}`);

                poiMarkers.push(marker);
            });
        }

        function highlightPoi(poi) {
            clearPoiMarkers();

            const marker = L.marker([poi.lat, poi.lon], {
                icon: L.divIcon({
                    className: 'poi-marker',
                    html: `<span style="background-color: ${poiCategories[poi.category].color}; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 16px;">${poiCategories[poi.category].icon}</span>`,
                    iconSize: [32, 32]
                })
            }).addTo(map)
                .bindPopup(`<b>${poi.name}</b><br>${poi.tags.description || ''}`)
                .openPopup();

            poiMarkers.push(marker);
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updateRoute() {
            resetRoute();
            if (markers.length === 2) {
                const [start, end] = markers.map(m => m.getLatLng());
                const url = `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.routes && data.routes.length > 0) {
                            const route = data.routes[0];
                            const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
                            routeLine = L.polyline(coords, {color: 'blue'}).addTo(map);

                            const distance = (route.distance / 1000).toFixed(2);
                            const duration = (route.duration / 60).toFixed(2);
                            const popupContent = `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distance} –∫–º<br>–í—Ä–µ–º—è: ${duration} –º–∏–Ω`;

                            L.popup()
                                .setLatLng(end)
                                .setContent(popupContent)
                                .openOn(map);

                            document.getElementById('saveRouteBtn').style.display = 'inline';

                            showNearbyPOIs();
                        }
                    });
            }
        }

        function saveRoute() {
            if (!{{ user.is_authenticated|yesno:"true,false" }}) {
                alert('–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }

            const [start, end] = markers.map(m => m.getLatLng());
            const routeData = {
                start_lat: start.lat,
                start_lng: start.lng,
                end_lat: end.lat,
                end_lng: end.lng,
                name: prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞') || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'
            };

            fetch('/api/save_route/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(routeData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    alert(`–ú–∞—Ä—à—Ä—É—Ç "${data.name}" —Å–æ—Ö—Ä–∞–Ω–µ–Ω!`);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            });
        }

        function showAuthAlert() {
            alert('–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updatePoiList);
        });

        map.on('click', function(e) {
            if (markers.length >= 2) {
                map.removeLayer(markers[0]);
                markers.shift();
                resetRoute();
                clearPoiMarkers();
                document.getElementById('poiPanel').style.display = 'none';
            }

            const marker = L.marker(e.latlng).addTo(map);
            markers.push(marker);

            marker.on('contextmenu', function() {
                map.removeLayer(marker);
                markers = markers.filter(m => m !== marker);
                resetRoute();
                clearPoiMarkers();
                document.getElementById('poiPanel').style.display = 'none';
            });

            if (markers.length === 2) {
                updateRoute();
            } else if (markers.length === 1) {
                showNearbyPOIs();
            }
        });

        document.getElementById('saveRouteBtn').addEventListener('click', saveRoute);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
        {% if login_error %}
        document.addEventListener('DOMContentLoaded', function() {
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
        });
        {% endif %}

        {% if register_errors %}
        document.addEventListener('DOMContentLoaded', function() {
            const registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
            registerModal.show();
        });
        {% endif %}
    </script>
</body>
</html>